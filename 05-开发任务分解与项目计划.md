# Polymarket Dump & Hedge 自动化交易系统
## 开发任务分解与项目计划

**文档版本**: v1.0  
**创建日期**: 2025年12月30日  
**作者**: Kyd  

---

## 1. 项目里程碑

```
Week 1-2: 基础设施 + 数据层
    ├── 项目初始化
    ├── WebSocket客户端
    ├── 数据录制器
    └── 基础数据库

Week 3-4: 核心交易引擎
    ├── 状态机实现
    ├── 暴跌检测器
    ├── 对冲策略
    └── 订单执行器

Week 5-6: 回测框架
    ├── 回放引擎
    ├── 模拟器
    ├── 参数优化
    └── 报告生成

Week 7-8: 集成测试 + 生产部署
    ├── E2E测试
    ├── 性能优化
    ├── 部署脚本
    └── 监控告警
```

---

## 2. 详细任务分解

### Phase 1: 基础设施 (Week 1-2)

#### Sprint 1.1: 项目初始化 (Day 1-2)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T001 | 初始化Node.js项目结构 | 2h | P0 | - |
| T002 | 配置TypeScript + ESLint | 1h | P0 | T001 |
| T003 | 设置环境变量管理 (dotenv) | 1h | P0 | T001 |
| T004 | 创建配置管理模块 | 2h | P0 | T003 |
| T005 | 设置日志系统 (Winston) | 2h | P1 | T001 |
| T006 | 创建项目文档结构 | 1h | P2 | - |

**交付物**:
- 可运行的项目骨架
- 配置文件模板
- 日志输出系统

#### Sprint 1.2: WebSocket客户端 (Day 3-5)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T007 | 研究Polymarket WS API文档 | 2h | P0 | - |
| T008 | 实现WebSocket连接管理 | 4h | P0 | T001 |
| T009 | 实现自动重连机制 | 3h | P0 | T008 |
| T010 | 实现心跳检测 | 2h | P0 | T008 |
| T011 | 实现市场订阅/取消订阅 | 2h | P0 | T008 |
| T012 | 价格数据解析与标准化 | 2h | P0 | T008 |
| T013 | 添加WebSocket单元测试 | 3h | P1 | T008-T012 |

**交付物**:
- WebSocket客户端模块
- 连接状态管理
- 测试覆盖

#### Sprint 1.3: 数据存储层 (Day 6-8)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T014 | 设计数据库Schema | 2h | P0 | - |
| T015 | 配置SQLite + better-sqlite3 | 1h | P0 | T001 |
| T016 | 实现价格快照存储 | 3h | P0 | T014, T015 |
| T017 | 实现交易周期存储 | 3h | P0 | T014, T015 |
| T018 | 实现订单历史存储 | 2h | P0 | T014, T015 |
| T019 | 实现数据查询接口 | 3h | P1 | T016-T018 |
| T020 | 数据库迁移脚本 | 2h | P1 | T014 |

**交付物**:
- 完整的数据库Schema
- CRUD操作接口
- 迁移工具

#### Sprint 1.4: 数据录制器 (Day 9-10)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T021 | 实现实时数据录制器 | 4h | P0 | T008, T016 |
| T022 | 实现批量写入优化 | 2h | P0 | T021 |
| T023 | 添加数据质量检查 | 2h | P1 | T021 |
| T024 | 实现录制状态监控 | 2h | P1 | T021 |
| T025 | 创建录制启动脚本 | 1h | P1 | T021 |

**交付物**:
- 独立运行的数据录制服务
- 数据质量报告

---

### Phase 2: 核心交易引擎 (Week 3-4)

#### Sprint 2.1: 状态机实现 (Day 11-13)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T026 | 设计状态机状态和转换 | 2h | P0 | - |
| T027 | 实现FSM核心逻辑 | 4h | P0 | T026 |
| T028 | 实现状态转换事件发射 | 2h | P0 | T027 |
| T029 | 实现状态持久化 | 2h | P1 | T027, T017 |
| T030 | 添加状态机单元测试 | 3h | P0 | T027 |
| T031 | 实现状态机可视化调试 | 2h | P2 | T027 |

**交付物**:
- 完整的状态机模块
- 状态转换图验证
- 单元测试

#### Sprint 2.2: 暴跌检测器 (Day 14-16)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T032 | 实现CircularBuffer数据结构 | 2h | P0 | - |
| T033 | 实现价格变动计算逻辑 | 3h | P0 | T032 |
| T034 | 实现时间窗口过滤 | 2h | P0 | T033 |
| T035 | 实现暴跌信号生成 | 2h | P0 | T033, T034 |
| T036 | 参数化检测阈值 | 2h | P0 | T035 |
| T037 | 添加检测器单元测试 | 3h | P0 | T032-T036 |

**交付物**:
- 暴跌检测模块
- 可配置参数
- 测试用例

#### Sprint 2.3: 对冲策略 (Day 17-19)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T038 | 实现对冲条件计算 | 3h | P0 | - |
| T039 | 实现收益计算逻辑 | 2h | P0 | - |
| T040 | 实现费用计算器 | 2h | P0 | - |
| T041 | 集成对冲策略与状态机 | 3h | P0 | T027, T038 |
| T042 | 添加策略单元测试 | 3h | P0 | T038-T041 |

**交付物**:
- 对冲策略模块
- 收益计算工具
- 费用估算

#### Sprint 2.4: 订单执行器 (Day 20-22)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T043 | 研究Polymarket REST API | 2h | P0 | - |
| T044 | 实现订单构建逻辑 | 3h | P0 | T043 |
| T045 | 实现订单签名 (ethers.js) | 4h | P0 | T044 |
| T046 | 实现订单提交 | 3h | P0 | T044, T045 |
| T047 | 实现订单状态查询 | 2h | P0 | T043 |
| T048 | 实现订单取消 | 2h | P1 | T043 |
| T049 | 实现重试机制 | 2h | P0 | T046 |
| T050 | 添加订单执行单元测试 | 3h | P0 | T044-T049 |

**交付物**:
- 订单执行模块
- 签名验证
- 错误处理

#### Sprint 2.5: 轮次管理器 (Day 23-24)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T051 | 实现轮次检测逻辑 | 3h | P0 | T008 |
| T052 | 实现轮次切换事件 | 2h | P0 | T051 |
| T053 | 实现未完成交易处理 | 3h | P0 | T051, T027 |
| T054 | 添加轮次管理测试 | 2h | P0 | T051-T053 |

**交付物**:
- 轮次管理模块
- 轮次切换处理

---

### Phase 3: 回测框架 (Week 5-6)

#### Sprint 3.1: 回放引擎 (Day 25-27)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T055 | 实现数据加载器 | 3h | P0 | T019 |
| T056 | 实现时间序列回放 | 4h | P0 | T055 |
| T057 | 实现事件生成器 | 2h | P0 | T056 |
| T058 | 添加数据质量验证 | 2h | P1 | T055 |

**交付物**:
- 回放引擎模块
- 数据验证工具

#### Sprint 3.2: 回测模拟器 (Day 28-31)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T059 | 实现回测状态机 | 3h | P0 | T027 |
| T060 | 实现虚拟订单执行 | 3h | P0 | - |
| T061 | 实现投资组合跟踪 | 3h | P0 | - |
| T062 | 实现权益曲线计算 | 2h | P0 | T061 |
| T063 | 集成回测组件 | 4h | P0 | T055-T062 |
| T064 | 添加回测验证测试 | 3h | P0 | T063 |

**交付物**:
- 完整回测模拟器
- 权益曲线输出

#### Sprint 3.3: 参数优化 (Day 32-34)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T065 | 实现网格搜索 | 4h | P0 | T063 |
| T066 | 实现并行回测 | 3h | P1 | T065 |
| T067 | 实现结果排序和筛选 | 2h | P0 | T065 |
| T068 | 实现最优参数导出 | 1h | P0 | T067 |

**交付物**:
- 参数优化工具
- 最优参数报告

#### Sprint 3.4: 报告生成 (Day 35-36)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T069 | 实现性能指标计算 | 3h | P0 | T063 |
| T070 | 实现文本报告生成 | 2h | P0 | T069 |
| T071 | 实现CSV导出 | 1h | P1 | T069 |
| T072 | 实现权益曲线图表 | 3h | P2 | T062 |

**交付物**:
- 回测报告模板
- 数据导出功能

---

### Phase 4: 集成与部署 (Week 7-8)

#### Sprint 4.1: 终端UI (Day 37-39)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T073 | 设计终端UI布局 | 2h | P1 | - |
| T074 | 实现状态显示面板 | 3h | P1 | T027 |
| T075 | 实现命令解析器 | 3h | P1 | - |
| T076 | 实现实时价格显示 | 2h | P1 | T008 |
| T077 | 实现交易历史显示 | 2h | P2 | T018 |

**交付物**:
- 交互式终端界面
- 命令行工具

#### Sprint 4.2: 集成测试 (Day 40-42)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T078 | 编写E2E测试场景 | 4h | P0 | - |
| T079 | 实现测试模拟器 | 3h | P0 | T063 |
| T080 | 执行完整交易周期测试 | 4h | P0 | T078, T079 |
| T081 | 压力测试 | 3h | P1 | - |

**交付物**:
- E2E测试套件
- 测试报告

#### Sprint 4.3: 生产部署 (Day 43-45)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T082 | 创建Dockerfile | 2h | P0 | - |
| T083 | 配置Docker Compose | 2h | P1 | T082 |
| T084 | 创建部署脚本 | 2h | P0 | T082 |
| T085 | 配置系统服务 (systemd) | 2h | P1 | - |
| T086 | 设置自动重启 | 1h | P0 | T085 |

**交付物**:
- Docker镜像
- 部署脚本

#### Sprint 4.4: 监控告警 (Day 46-48)

| 任务ID | 任务描述 | 预估工时 | 优先级 | 依赖 |
|--------|----------|----------|--------|------|
| T087 | 集成Telegram Bot | 3h | P1 | - |
| T088 | 定义告警规则 | 2h | P1 | T087 |
| T089 | 实现健康检查端点 | 2h | P1 | - |
| T090 | 配置日志轮转 | 1h | P2 | T005 |
| T091 | 创建运维文档 | 2h | P1 | - |

**交付物**:
- 告警系统
- 运维手册

---

## 3. 技术栈清单

### 3.1 核心依赖

```json
{
  "dependencies": {
    "ws": "^8.x",
    "better-sqlite3": "^9.x",
    "ethers": "^6.x",
    "dotenv": "^16.x",
    "winston": "^3.x",
    "eventemitter3": "^5.x",
    "axios": "^1.x",
    "yargs": "^17.x",
    "blessed": "^0.1.x"
  },
  "devDependencies": {
    "typescript": "^5.x",
    "jest": "^29.x",
    "eslint": "^8.x",
    "@types/node": "^20.x",
    "@types/ws": "^8.x",
    "@types/better-sqlite3": "^7.x"
  }
}
```

### 3.2 基础设施

| 组件 | 选型 | 用途 |
|------|------|------|
| 运行时 | Node.js 20 LTS | 主程序运行 |
| 数据库 | SQLite 3 | 本地数据存储 |
| 容器 | Docker | 部署隔离 |
| 服务管理 | systemd | 进程管理 |
| 告警 | Telegram Bot API | 实时通知 |

---

## 4. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| API变更 | 高 | 中 | 抽象API层，快速适配 |
| 网络不稳定 | 高 | 高 | 完善重试机制，本地缓存 |
| 测试数据不足 | 中 | 中 | 尽早开始数据录制 |
| 性能不达标 | 中 | 低 | 预留Rust重写时间 |
| 资金损失 | 高 | 低 | 小资金测试，保守参数 |

---

## 5. 验收标准

### 5.1 功能验收

| 功能 | 验收标准 |
|------|----------|
| 价格监控 | 延迟 < 100ms, 断连重试成功 |
| 暴跌检测 | 正确识别测试数据中的暴跌 |
| 对冲执行 | 满足条件时自动触发 |
| 回测 | 结果可复现，与手动计算一致 |
| 终端UI | 命令响应 < 500ms |

### 5.2 非功能验收

| 指标 | 验收标准 |
|------|----------|
| 可用性 | 连续运行24h无崩溃 |
| 性能 | CPU < 20%, 内存 < 512MB |
| 日志 | 关键操作100%记录 |
| 测试覆盖 | 核心模块 > 80% |

---

## 6. 团队分工建议

若多人协作：

| 角色 | 职责 | 任务范围 |
|------|------|----------|
| 后端工程师 | 核心逻辑开发 | T026-T054, T059-T064 |
| 基础设施工程师 | 数据层+部署 | T007-T025, T082-T091 |
| 量化分析师 | 策略+回测 | T038-T042, T065-T072 |

---

## 7. 检查清单

### 7.1 开发前检查

- [ ] 确认Polymarket API访问权限
- [ ] 准备测试钱包和测试资金
- [ ] 设置开发环境 (Node.js, SQLite)
- [ ] 克隆项目模板
- [ ] 配置环境变量

### 7.2 上线前检查

- [ ] 所有单元测试通过
- [ ] E2E测试覆盖核心流程
- [ ] 回测结果符合预期
- [ ] 告警系统正常工作
- [ ] 备份恢复流程验证
- [ ] 运维文档完善
- [ ] 小资金实盘测试通过

---

## 附录: 快速启动指南

```bash
# 1. 克隆项目
git clone <repo-url>
cd polymarket-bot

# 2. 安装依赖
npm install

# 3. 配置环境变量
cp .env.example .env
# 编辑 .env 填写API密钥等

# 4. 初始化数据库
npm run db:migrate

# 5. 启动数据录制 (后台运行)
npm run recorder &

# 6. 运行回测
npm run backtest -- --config ./config/test.json

# 7. 启动交易机器人 (测试模式)
npm run bot -- --dry-run

# 8. 启动交易机器人 (实盘)
npm run bot
```
