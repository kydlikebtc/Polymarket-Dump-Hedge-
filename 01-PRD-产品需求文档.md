# Polymarket Dump & Hedge 自动化交易系统
## 产品需求文档 (PRD)

**文档版本**: v1.0  
**创建日期**: 2025年12月30日  
**作者**: Kyd  
**状态**: Draft

---

## 1. 产品概述

### 1.1 产品愿景
构建一个全自动化的Polymarket预测市场套利机器人，专注于BTC 15分钟UP/DOWN市场，通过"暴跌接针+无风险对冲"策略捕捉市场恐慌性错误定价机会，实现稳定的低风险收益。

### 1.2 核心价值主张
- **自动化执行**: 7x24小时无人值守运行，自动识别交易机会
- **风险可控**: 双腿对冲机制确保在满足条件时实现无风险套利
- **参数可调**: 灵活的参数配置系统，适应不同市场环境
- **数据驱动**: 完整的回测框架验证策略有效性

### 1.3 目标用户
- 具备量化交易经验的个人投资者
- 熟悉加密货币市场的专业交易者
- 对预测市场套利感兴趣的开发者

---

## 2. 产品范围

### 2.1 核心功能 (MVP)

| 功能模块 | 优先级 | 描述 |
|---------|--------|------|
| 实时价格监控 | P0 | WebSocket订阅best bid/ask，毫秒级响应 |
| 暴跌检测引擎 | P0 | 3秒内价格变动检测，触发Leg 1 |
| 对冲执行模块 | P0 | 自动计算并执行Leg 2对冲交易 |
| 轮次管理器 | P0 | 自动切换BTC 15分钟轮次 |
| 参数配置系统 | P1 | 运行时动态调整交易参数 |
| 终端UI界面 | P1 | 固定布局实时显示状态 |
| 手动交易模式 | P2 | 支持手动下单和干预 |

### 2.2 扩展功能 (Future)

| 功能模块 | 优先级 | 描述 |
|---------|--------|------|
| 回测框架 | P1 | 历史数据回放验证策略 |
| 多市场支持 | P2 | 扩展至其他预测市场标的 |
| 风控告警 | P2 | 异常情况Telegram/Discord通知 |
| Web Dashboard | P3 | 可视化监控面板 |

---

## 3. 功能需求详述

### 3.1 实时价格监控模块

**FR-001**: 系统应能通过WebSocket连接Polymarket CLOB API

**FR-002**: 系统应每秒记录以下数据快照：
- 时间戳 (毫秒精度)
- 当前轮次slug
- 剩余秒数
- UP/DOWN Token ID
- UP/DOWN best ask价格

**FR-003**: 系统应在连接断开时自动重连，最大重试次数5次

### 3.2 暴跌检测引擎

**FR-004**: 系统应支持配置以下检测参数：
- `windowMin`: 监控窗口时长 (默认2分钟)
- `movePct`: 暴跌阈值百分比 (默认15%)
- 检测周期：约3秒

**FR-005**: 当检测到任一方向价格在3秒内下跌超过`movePct`时，触发Leg 1信号

**FR-006**: Leg 1触发后，系统应锁定该方向，不再对同方向发出买入信号

### 3.3 对冲执行模块

**FR-007**: 系统应持续监控对冲条件：
```
leg1EntryPrice + oppositeAsk <= sumTarget
```

**FR-008**: 当对冲条件满足时，自动执行Leg 2买入对手方

**FR-009**: Leg 2完成后，系统应重置状态，准备下一轮监控

### 3.4 订单执行

**FR-010**: 系统应支持两种订单类型：
- Market Order: 以best ask价格立即成交
- Limit Order (GTC): 按指定价格挂单

**FR-011**: 订单参数应包含：
- 交易方向 (UP/DOWN)
- 数量 (shares或USD金额)
- 价格 (Limit Order)

### 3.5 轮次管理

**FR-012**: 系统应自动检测当前BTC 15分钟轮次

**FR-013**: 轮次切换时：
- 如果有未完成的Leg 1 (未对冲)，按全损处理
- 重置所有状态
- 开始新轮次监控

---

## 4. 非功能需求

### 4.1 性能需求

| 指标 | 要求 |
|------|------|
| 价格更新延迟 | < 100ms |
| 订单提交延迟 | < 500ms |
| 检测响应时间 | < 1s |
| 系统可用性 | > 99% |
| 内存占用 | < 512MB |

### 4.2 安全需求

- API密钥安全存储 (环境变量或加密文件)
- 私钥不得明文存储
- 支持只读模式 (仅监控不交易)

### 4.3 可观测性

- 结构化日志输出 (JSON格式)
- 交易记录持久化
- 实时状态展示

---

## 5. 用户故事

### US-001: 作为交易者，我想启动自动交易模式
**验收标准**:
- 输入 `auto on 20 sum=0.95 move=0.15 windowMin=2`
- 系统开始监控，终端显示当前状态
- 检测到暴跌时自动执行Leg 1
- 满足对冲条件时自动执行Leg 2

### US-002: 作为交易者，我想手动执行交易
**验收标准**:
- 输入 `buy up 100` 以$100买入UP
- 输入 `buyshares down 50` 买入50份DOWN
- 订单立即执行并显示成交结果

### US-003: 作为交易者，我想查看当前持仓和损益
**验收标准**:
- 终端实时显示：
  - 当前轮次信息
  - UP/DOWN 当前价格
  - 持仓数量和成本
  - 浮动盈亏

---

## 6. 成功指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 月化收益率 | > 20% | 累计收益/初始本金 |
| 胜率 | > 70% | 盈利交易/总交易数 |
| 最大回撤 | < 15% | 峰值到谷底的最大跌幅 |
| 系统正常运行时间 | > 99% | 可用时间/总时间 |

---

## 7. 风险与缓解

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| API连接中断 | 高 | 中 | 自动重连机制，本地数据缓存 |
| 订单执行滑点 | 中 | 高 | 保守参数设置，预留滑点空间 |
| 市场结构变化 | 高 | 低 | 持续监控，定期参数优化 |
| 资金不足 | 高 | 低 | 余额检查，自动暂停 |

---

## 8. 里程碑计划

| 阶段 | 时间 | 交付物 |
|------|------|--------|
| Phase 1: 核心引擎 | Week 1-2 | 价格监控 + 暴跌检测 + 基础订单 |
| Phase 2: 自动化 | Week 3-4 | 双腿自动执行 + 轮次管理 |
| Phase 3: 回测 | Week 5-6 | 回测框架 + 参数优化 |
| Phase 4: 优化 | Week 7-8 | 性能优化 + 生产部署 |

---

## 附录A: 术语表

| 术语 | 定义 |
|------|------|
| Leg 1 | 首次买入暴跌方向的交易 |
| Leg 2 | 对冲交易，买入对手方 |
| sumTarget | UP+DOWN价格之和的目标阈值 |
| movePct | 触发Leg 1的价格变动百分比 |
| windowMin | 每轮开始后允许Leg 1的时间窗口 |
| CLOB | Central Limit Order Book |
